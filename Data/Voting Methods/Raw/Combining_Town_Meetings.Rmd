---
title: "VT Town Meeting Cleaning"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Packages
```{r}
pacman::p_load(tidyverse, sf, glue, purrr, readxl, stringr, janitor)
```


## Reading Datasets
```{r}
methods_2017 <- readxl::read_xlsx("2017_town_meeting_voting_methods.xlsx", skip = 2) |> 
  slice(-1) |> 
  mutate(year = 2017)

methods_2018 <- readxl::read_xlsx("2018_annual_meeting_voting_methods.xlsx", skip = 1) |> 
  slice(-1) |> 
  mutate(year = 2018)

methods_2019 <- readxl::read_xlsx("2019_annual_meeting_voting_methods.xlsx", skip = 1) |> 
  slice(-1) |> 
  mutate(year = 2019)

methods_2020 <- readxl::read_xlsx("2020_annual_meeting_voting_methods.xlsx", skip = 1) |> 
  slice(-1) |> 
  mutate(year = 2020)
  
methods_2021 <- readxl::read_xlsx("2021_annual_meeting_voting_methods.xlsx", skip = 1) |> 
  slice(-1) |> 
  mutate(year = 2021)
  
methods_2022 <- readxl::read_xlsx("2022_annual_meeting_voting_methods.xlsx", skip = 1) |> 
  slice(-1) |> 
  mutate(year = 2022)
  
methods_2023 <- readxl::read_xlsx("2023_annual_meeting_voting_methods.xlsx", skip = 1) |> 
  slice(-1) |> 
  mutate(year = 2023)
  
methods_2024 <- readxl::read_xlsx("2024_annual_meeting_voting_methods.xlsx", skip = 1) |> 
  slice(-1) |> 
  mutate(year = 2024)

methods_2025 <- read.csv("2025_annual_meeting_voting_methods.csv") |> 
  mutate(year = 2025)
  
```



## Combine Datasets
```{r}
combined_df <- bind_rows(
  methods_2017, methods_2018, methods_2019, 
  methods_2020, methods_2022, methods_2023, methods_2024
)

tibble(combined_df)
```


## Convert Combined Dataset into Long Format
```{r}

combined_df_long <- 
  combined_df |> 
  pivot_longer(
    cols = -c(`Town Clerk's Office  -                                                                                    Town or City`, year),
    names_to = "method_description",
    values_to = "usage"
  )

```



## Simplifying Voting Method Names

#### Documentation Notes

* *town* = Town Level
* *union_sd* = Union School District
* *ab* = Australian Ballot Voting
* *sd* = School District
* *moved_2018* = Whether or not the town converted to Australian Ballot voting in 2018
* *q* = Questions
* *public_q* = Public Questions
* *officers* = Officers
* *budget* = Budget


```{r}

combined_df_long <- combined_df_long |> 
  mutate(
    voting_method = case_when(
      method_description == "Does your town use AUSTRALIAN BALLOT voting for TOWN OFFICERS?" ~ "town_ab_officers",
      method_description == "Does your town use AUSTRALIAN BALLOT voting for TOWN BUDGET?" ~ "town_ab_budget",
      method_description == "Does your town use AUSTRALIAN BALLOT voting for TOWN PUBLIC QUESTIONS?" ~ "town_ab_public_q",
      method_description == "Does your town use AUSTRALIAN BALLOT voting for TOWN SCHOOL DISTRICT OFFICERS?" ~ "town_sd_ab_officers",
      method_description == "Does your town use AUSTRALIAN BALLOT voting for TOWN SCHOOL DISTRICT BUDGET?" ~ "town_sd_ab_budget",
      method_description == "Does your town use AUSTRALIAN BALLOT voting for TOWN SCHOOL DISTRICT PUBLIC QUESTIONS?" ~ "town_sd_ab_public_q",
      method_description == "Did your town move to AUSTRAILIAN BALLOT voting for your budget, officers, or public questions at 2018 Town Meeting?" ~ "town_ab_moved_2018",
      method_description == "Is your town a member of UNION SCHOOL DISTRICT?" ~ "union_sd_member",
      method_description == "Does your UNION SCHOOL DISTRICT use AUSTRALIAN BALLOTS voting for OFFICERS?" ~ "union_sd_ab_officers",
      method_description == "Does your UNION SCHOOL DISTRICT use AUSTRAILIAN BALLOT voting for BUDGET?" ~ "union_sd_ab_budget",
      method_description == "Does your UNION SCHOOL DISTRICT use AUSTRALIAN BALLOT voting for PUBLIC QUESTIONS?" ~ "union_sd_ab_public_q",
      TRUE ~ method_description
    )
  )
```


## Clean Missing Values and Usage Names

```{r}
yes <- c("Yes", "YES")
no <- c("No", "NO")
missing <- c("N/A", "n/a", NA)

df <- 
  combined_df_long |> 
  mutate(
    usage = case_when(
      usage %in% yes ~ "Yes", # Coding YES
      usage %in% no ~ "No", # Coding NO
      usage %in% missing ~ NA, # Coding MISSING VALUES
      usage == "only zoning" ~ "Only Zoning",
      usage == "only Treasurer" ~ "Only Treasurer",
      usage == "only selectboard members" ~ "Only Selectboard Members",
      usage == "special elections" ~ "Special Elections",
      usage == "only bonding articles" ~ "Only Bonding Articles",
      .default = usage
    )
  ) |> 
  rename("town_city" = "Town Clerk's Office  -                                                                                    Town or City") |> 
  mutate(town_city = str_to_title(town_city))

```

## Write Long Format Dataset to CSV
```{r}

# write_csv(df, "town_meeting_voting_methods_long.csv")

```


